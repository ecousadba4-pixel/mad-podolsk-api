# PDF Reports Backend (СКПДИ · МАД · Подольск)

Сервис отвечает за **подготовку и генерацию PDF-отчётов** по данным дашборда только из раздела По месяцам.

Фронтенд (Vue-дашборд) по нажатию кнопки обращается к этому сервису,  
получает готовый `application/pdf` и осуществляет выгрузку на устройство пользователя..

## 1. Архитектура и стек

- **Язык**: Python
- **Веб-фреймворк**: FastAPI
- **WSGI/ASGI сервер**: uvicorn / gunicorn + uvicorn worker
- **База данных**: PostgreSQL (используются готовые view и таблицы)
- **Генерация PDF**:  
  - HTML-шаблон → CSS для печати → WeasyPrint → PDF-файл
- **Шаблонизатор**: Jinja2
- **Менеджмент зависимостей**:
  - `pip + requirements.txt`

Идея: логика «что такое отчёт» (данные, структура, шаблоны) живёт здесь, фронтенд лишь передаёт параметры и скачивает готовый файл.

## 2. Основные сценарии использования

1. Пользователь открывает дашборд (Vue-фронт).
2. Нажимает кнопку **«Скачать отчёт в PDF»**.
3. Фронтенд отправляет запрос, например:

   ```http
   GET /reports/monthly?month=2025-11
   Accept: application/pdf
4. Бекенд:
    подтягивает данные из PostgreSQL;
    подготавливает структуру отчёта;
    рендерит HTML через Jinja2;
    конвертирует HTML в PDF через WeasyPrint;
    отправляет PDF потоком (streaming response).
5. Браузер пользователя: сохраняет его как файл Report_MAD_Podolsk_MM-YYYY.pdf. где MM-YYYY это выбранный месяц и год в интерфейсе дашборда в момент нажатии кнопки PDF для выгрузки отчета.

## 3. Переменные окружения Backend

1. URL/DSN подключения к Postgres: DB_DSN
2. Базовый URL фронтенда (если нужно для генерации ссылок в отчёте): FRONTEND_BASE_URL
3. REPORT_QUERY_TIMEOUT=30
4. MAX_REPORT_ROWS=5000

## 4. Эндпоинты API

Получение PDF-отчёта по месяцу: GET /reports/monthly

Пример:
GET /reports/monthly?month=2025-11
Accept: application/pdf

## 5. SQL Источник данных для отчета

База данных Postgres с подключением через переменную в окружении

Представление: skpdi_fact_monthly_total
    В нем есть столбцы:
        1. month_start - первое число месяца
        2. description - вид работ
        3. unit - единица измерения
        4. fact_volume_done - объем выполненной работы в единицах измерения
        5. fact_amount_done - сумма в деньгах
        6. smeta_code - название сметы

Таблица: skpdi_fact_agg
    В ней есть столбец:
        1.loaded_at - дата последней загрузки данных

## 6. Поток данных внутри сервиса

    1. Разбор параметров запроса - FastAPI валидирует month Pydantic-схемы
    
    2. Нормализация параметров - приведение месяца 2025-11 к date(2025, 11, 1)
    
    3. Получение данных из БД
        В repositories/reports_repo.py выполняется один SQL-запрос:
            помесячная сводка (план/факт/отклонение);
            детализация по видам работ;
            дополнительные агрегаты (итоги по смете, итоговое значение).

    4. Формирование структуры отчёта
        В services/reports_service.py:
            1. данные из репозитория приводятся к удобному DTO:
                MonthlyReportData(
                    month_start=...,
                    smeta_code=...,
                    description= ...,
                    unit= ...,
                    fact_volume_done=...,
                    fact_amount_done=...
                )
            2. Данные агрегируются (Group by) по колонкам month_start, smeta_code, description, unit
    
    5. Рендер HTML-шаблона
        В pdf/generator.py:
            Jinja2 рендерит monthly_report.html с переданным MonthlyReportData;
            подключаются CSS-файлы (print.css)
    
    6. Преобразование HTML → PDF
        WeasyPrint превращает готовый HTML в бинарный PDF.
    
    7. Отправка ответа
        FastAPI возвращает StreamingResponse с Content-Type: application/pdf
        и заголовком Content-Disposition: attachment; Report_MAD_Podolsk_MM-YYYY.pdf".

## 7. Интеграция с фронтендом (Vue)

Во фронтенде (Vue-дашборд) есть кнопка «Скачать отчёт PDF»
    Кнопка PDF:
        1. Отдельный Vue компонент
        2. Нажатие возможно только в разделе По месяца
        3. В разделе По дням кнопка неактивна и имеет приглушенный отключенный вид
        4. Кнопка доступна только в ПК версии, в мобильной версии отключена
        5. Кнопка располагается внутри AppHeader.vue - в один ряд с другими элемента, крайняя с правой стороны - кнопка по высоте такого же размера как остальные элементы в этом компоненте Vue 
        6. На кнопке иконка скачивания + надпись "PDF"
fetch + blob: хочется контролировать имя файла и поведение скачивания

## 8. Макет отчета

### Заголовок
    Сводный отчёт по работам Подольск
    Дата формирования: "указываем дату выгрузки отчета"
    Дата обновления данных: "указываем самую свежую дату из столбца loaded_at из таблицы skpdi_fact_agg - формат даты "27 ноября 2025" "
    Указаны работы со статусом Рассмотрено в СКПДИ

### Таблица
Колонка 1
    Заголовок - Смета
    Значение - smeta_code указывается один раз для всех сгруппированных видов работ в следующем столбце
Колонка 2
    Заголовок - Вид работы
    Значение - description
Колонка 3
    Заголовок - Ед. изм. 
    Значение - unit
Колонка 3
    Заголовок - Объем
    Значение - fact_volume_done
Колонка 4
    Заголовок - Сумма
    Значение - fact_amount_done

На уровне smeta_code делаем промежуточные итоги по description входящим в данный smeta_code по столбцу Сумма.
description внутри каждой smeta_code сортируются по  столбцу Сумма от большего значения к меньшему.
Внизу всей таблицы делается строка Итого с общей суммой по столбцу Сумма

### Оформление
    Заголовок таблицы - выделяется темным серым 
    Уровень smeta_code - выделяется средне серым
    Промежуточные итоги жирным шрифтом + заливка серым цветом
    Строка Итого контрастная заливка и шрифт жирный
    Используется шрифт Manrope расположен в репозитории по адресу frontend/public/fonts/manrope
    Столбцы Смета, Ед. изм., Объем, Сумма - занимает минимально необходимую ширину, чтобы были видны значения
    Столбец Вид работы имеет максимальную ширину, возможен перенос длинных названий по строкам
    Таблица по ширине должна находиться в пределах листа формата А4
    ВАЖНО - весь отчет всегда только на 1 странице - автоматическая адаптация шрифтов


