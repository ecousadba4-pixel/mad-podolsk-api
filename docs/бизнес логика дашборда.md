# БД postgres 
## 1. skpdi_plan_vs_fact_monthly (Представление)
    В нем есть столбцы:
        1. month_start - месяц данных
        2. smeta_code - название сметы
        3. description - вид работ
        4. planned_amount - сумма плана в деньгах
        5. fact_amount_done - сумма факта в деньгах
## 2. podolsk_mad_2025_contract_amount (таблица)
    В нем есть столбцы:
        1. contract_amount - сумма контракта в деньгах
## 3. skpdi_fact_with_money (Представление)
    В нем есть столбцы:
        1. date_done - дата
        2. status - статус выполнения работы
        3. description - вид работ
        4. unit - единица измерения
        5. total_volume - объем выполненной работы в единицах измерения
        6. total_amount - сумма в деньгах
        7. smeta_code - название сметы

# Расчет показателей на стороне приложения из БД
1. plan_leto = сумма всех planned_amount где smeta_code равен "Лето" отфильтрованный по выбранному месяцу в дашборде
2. plan_zima = сумма всех planned_amount где smeta_code равен "Зима" отфильтрованный по выбранному месяцу в дашборде
3. plan_vnereglament = (plan_leto + plan_zima)*0,43
4. plan_total = plan_leto + plan_zima + plan_vnereglament
5. fact_leto = сумма всех fact_amount_done где smeta_code равен "Лето" отфильтрованный по выбранному месяцу в дашборде
6. fact_zima = сумма всех fact_amount_done где smeta_code равен "Зима" отфильтрованный по выбранному месяцу в дашборде
7. fact_vnereglament = сумма всех fact_amount_done где smeta_code равен "Внерегламент ч.1" или "Внерегламент ч.2" отфильтрованный по выбранному месяцу в дашборде
8. fact_total = fact_leto + fact_zima + fact_vnereglament
9. summa_contract = summa_contract (podolsk_mad_2025_contract_amount )
10. contract_planfact_pct = fact_total / summa_contract

# Показатели в дашборде
## Секция По месяцам
###  Раздел "Исполнение контракта"
####  Показатели
1. Контракт - summa_contract
2. Выполнено - fact_total
3. Исполнение - contract_planfact_pct

###  Раздел summary KPI
####  Показатели в отдельных карточках
1. План = plan_total
2. Факт = fact_total
3. Отклонение = разница между fact_total и plan_total
4. Ср. днев. выручка = fact_total текущего календарного месяца разделенный на количество дней в текущем календарном месяцем за вычетом 1 дня сегодня
#### Модальное окно "Выручка по дням"
Для этого раздела делается таблица со следующими колонками
1. Дата
    date_done из skpdi_fact_with_money агрегированное по date_done
2. Сумма
    total_amount из skpdi_fact_with_money агрегированное по date_done для тех строк где status равен "Рассмотрено"

###  Раздел "Работы в разрезе Смет"
####  Показатели в отдельных карточках
Показываются три карточки - Зима, Лето, Внерегламент.
В каждой карточке три показателя План, Факт, Отклонение
1. Для карточки Лето
    План = plan_leto
    Факт = fact_leto
    Отклонение = fact_leto - plan_leto
3. Для карточки Зима
    План = plan_zima
    Факт = fact_zima
    Отклонение = fact_zima - plan_zima
4. Для карточки Внерегламент
    План = plan_vnereglament
    Факт = fact_vnereglament
    Отклонение = fact_vnereglament - plan_vnereglament

###  Раздел "Расшифровка работ по смете"
Если в Раздел Работы в разрезе Смет выбрана карточка Лето, значит smeta_code равен "Лето"
Если в Раздел Работы в разрезе Смет выбрана карточка Зима, значит smeta_code равен "Зима"
Если в Раздел Работы в разрезе Смет выбрана карточка Внерегламент, значит smeta_code равен "Внерегламент ч.1" или "Внерегламент ч.2"

#### Для этого раздела делается таблица со следующими колонками
1. Работы
    Показывается список description отфильтрованный в skpdi_plan_vs_fact_monthly по smeta_code на основании выбранной карточки в Раздел Работы в разрезе Смет
2. План
    сумма всех planned_amount из skpdi_plan_vs_fact_monthly где smeta_code равен на основании выбранной карточки в Раздел Работы в разрезе Смет отфильтрованный по выбранному месяцу в дашборде, если в Раздел Работы в разрезе Смет выбрана карточка внерегламент, то в поле План ставим 0
3. Факт
    сумма всех fact_amount_done из skpdi_plan_vs_fact_monthly где smeta_code равен на основании выбранной карточки в Раздел Работы в разрезе Смет отфильтрованный по выбранному месяцу в дашборде
4. Отклонение
    разница между Факт и План по данному description
Показывается description только если для этого description значение План или Факт больше 1.
#### Модальное окно "Расшифровка работ по дям"
Для этого раздела делается таблица со следующими колонками отфильтрованная по выбранному description
1. Дата
    date_done из skpdi_fact_with_money агрегированное по date_done
2. Объем
    total_volume из skpdi_fact_with_money агрегированное по date_done для тех строк где status равен "Рассмотрено" + в скобках первое из значений в столбце unit
3. Сумма
    total_amount из skpdi_fact_with_money агрегированное по date_done для тех строк где status равен "Рассмотрено"

## Секция По дням
Отображается таблица отфильтрованная по выбранной дате
1. Работы
    Показывается агрегированный список description из skpdi_fact_with_money для которых status равен "Рассмотрено"
2. Единица измерения
3. Объем
    Сумма для агрегированного description по столбцу total_volume + в скобках первое из значений в столбце unit
4. Сумма
    Сумма для агрегированного description по столбцу total_amount
Добавляется строка Итого по Сумма
