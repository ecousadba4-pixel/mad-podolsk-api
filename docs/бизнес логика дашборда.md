# БД postgres
Все таблицы описаны в файле "Postgres DB.md"

# Расчет показателей на стороне приложения из БД
1. plan_leto = сумма всех planned_amount где smeta_code равен "Лето" отфильтрованный по выбранному месяцу в дашборде
2. plan_zima = сумма всех planned_amount где smeta_code равен "Зима" отфильтрованный по выбранному месяцу в дашборде
3. plan_vnereglament = (plan_leto + plan_zima)*0,43
4. plan_total = plan_leto + plan_zima + plan_vnereglament
5. fact_leto = сумма всех fact_amount_done где smeta_code равен "лето" отфильтрованный по выбранному месяцу в дашборде
6. fact_zima = сумма всех fact_amount_done где smeta_code равен "зима" отфильтрованный по выбранному месяцу в дашборде
7. fact_vnereglament = сумма всех fact_amount_done где smeta_code равен "Внерегламент ч.1" или "Внерегламент ч.2" отфильтрованный по выбранному месяцу в дашборде
8. fact_total = fact_leto + fact_zima + fact_vnereglament
9. summa_contract = summa_contract (podolsk_mad_2025_contract_amount )
10. contract_planfact_pct = fact_total / summa_contract

# Показатели в дашборде
## Секция По месяцам
###  Раздел "Исполнение контракта"
####  Показатели
1. Контракт - summa_contract
2. Выполнено - fact_total
3. Исполнение - contract_planfact_pct

###  Раздел summary KPI
####  Показатели в отдельных карточках
1. План = plan_total
2. Факт = fact_total
3. Отклонение = разница между fact_total и plan_total
4. Ср. днев. выручка = fact_total текущего календарного месяца разделенный на количество дней в текущем календарном месяцем за вычетом 1 дня сегодня
#### Модальное окно "Выручка по дням"
Для этого раздела делается таблица со следующими колонками
1. Дата
    date_done из mv_fact_daily_amounts агрегированное по date_done
2. Сумма
    total_amount из mv_fact_daily_amounts агрегированное по date_done для тех строк где id_status равен "3" (Рассмотрено)

###  Раздел "Работы в разрезе Смет"
####  Показатели в отдельных карточках
Показываются три карточки - зима, лето, внерегламент.
В каждой карточке три показателя План, Факт, Отклонение
1. Для карточки лето
    План = plan_leto
    Факт = fact_leto
    Отклонение = fact_leto - plan_leto
3. Для карточки зима
    План = plan_zima
    Факт = fact_zima
    Отклонение = fact_zima - plan_zima
4. Для карточки внерегламент
    План = plan_vnereglament
    Факт = fact_vnereglament
    Отклонение = fact_vnereglament - plan_vnereglament

###  Раздел "Расшифровка работ по смете"
Если в Раздел Работы в разрезе Смет выбрана карточка лето, значит smeta_code равен "лето"
Если в Раздел Работы в разрезе Смет выбрана карточка зима, значит smeta_code равен "зима"
Если в Раздел Работы в разрезе Смет выбрана карточка внерегламент, значит smeta_code равен "Внерегламент ч.1" или "Внерегламент ч.2"

#### Для этого раздела делается таблица со следующими колонками
1. Работы
    Показывается список description отфильтрованный в mv_plan_vs_fact_monthly_ids по id_smeta или smeta_code на основании выбранной карточки в Раздел Работы в разрезе Смет
2. План
    сумма всех planned_amount из mv_plan_vs_fact_monthly_ids где id_smeta или smeta_code равен на основании выбранной карточки в Раздел Работы в разрезе Смет отфильтрованный по выбранному месяцу в дашборде, если в Раздел Работы в разрезе Смет выбрана карточка внерегламент, то в поле План ставим 0
3. Факт
    сумма всех fact_amount_done из mv_plan_vs_fact_monthly_ids где id_smeta или smeta_code равен на основании выбранной карточки в Раздел Работы в разрезе Смет отфильтрованный по выбранному месяцу в дашборде
4. Отклонение
    разница между Факт и План по данному description
Показывается description только если для этого description значение План или Факт больше 1.
#### Модальное окно "Расшифровка работ по дям"
Для этого раздела делается таблица со следующими колонками отфильтрованная по выбранному description
1. Дата
    date_done из mv_fact_daily_amounts агрегированное по date_done
2. Объем
    total_volume из mv_fact_daily_amounts агрегированное по date_done для тех строк где id_status равен "3" (Рассмотрено) + в скобках первое из значений в столбце unit
3. Сумма
    total_amount из mv_fact_daily_amounts агрегированное по date_done для тех строк где id_status равен "3" (Рассмотрено)

## Секция По дням
Отображается таблица отфильтрованная по выбранной дате
1. Работы
    Показывается агрегированный список description из mv_fact_daily_amounts для которых id_status равен "3" (Рассмотрено)
2. Единица измерения
3. Объем
    Сумма для агрегированного description по столбцу total_volume + в скобках первое из значений в столбце unit
4. Сумма
    Сумма для агрегированного description по столбцу total_amount
Добавляется строка Итого по Сумма