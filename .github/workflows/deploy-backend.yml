name: Deploy backend to MAD VPS

on:
  push:
    branches: [ main ]
    paths:
      - 'app/**'
      - 'scripts/**'
      - 'requirements.txt'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Copy backend code to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 89.104.74.37
          username: apps
          key: ${{ secrets.VPS_SSH_KEY_MAIN }}
          source: |
            app
            scripts
            requirements.txt
          target: /home/apps/mad_podolsk_api_new
          rm: true

      - name: Deploy and restart backend service
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: 89.104.74.37
          username: apps
          key: ${{ secrets.VPS_SSH_KEY_MAIN }}
          script: |
            set -e

            # Останавливаем сервис
            sudo systemctl stop mad-podolsk-api.service || true

            # Бэкапим текущую версию
            if [ -d /home/apps/mad_podolsk_api ]; then
              rm -rf /home/apps/mad_podolsk_api_prev
              mv /home/apps/mad_podolsk_api /home/apps/mad_podolsk_api_prev
            fi

            # Перекладываем новую версию на боевой путь
            mv /home/apps/mad_podolsk_api_new /home/apps/mad_podolsk_api
            cd /home/apps/mad_podolsk_api

            # venv предполагаем уже созданным на VPS
            if [ -d venv ]; then
              source venv/bin/activate
              pip install --upgrade pip
              pip install -r requirements.txt
            else
              python3 -m venv venv
              source venv/bin/activate
              pip install --upgrade pip
              pip install -r requirements.txt
            fi

            # Запуск сервиса
            sudo systemctl start mad-podolsk-api.service
            sudo systemctl status mad-podolsk-api.service --no-pager -l
