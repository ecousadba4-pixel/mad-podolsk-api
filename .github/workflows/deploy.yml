name: Build and Deploy Vite frontend

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      FRONTEND_DIR: frontend
      BUILD_DIR: frontend/dist

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          npm ci --prefix ${{ env.FRONTEND_DIR }}

      - name: Build Vite frontend
        run: |
          npm run build --prefix ${{ env.FRONTEND_DIR }}

      - name: Start ssh-agent and add key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_MAD }}

      - name: Add remote host to known_hosts (safer than disabling checks)
        run: |
          mkdir -p ~/.ssh
          if [ -n "${{ secrets.DEPLOY_HOST }}" ]; then
            ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts
          fi

      - name: Debug SSH (temporary)
        if: always()
        run: |
          echo "--- SSH debug start ---"
          mkdir -p ~/.ssh
          # write provided key to a temp file
          echo "Writing private key to /tmp/deploy_key"
          printf "%s" "${{ secrets.SSH_PRIVATE_KEY_MAD }}" > /tmp/deploy_key
          # set strict permissions immediately so ssh-keygen/ssh accept the key
          chmod 600 /tmp/deploy_key
          echo "Key fingerprint (private key):"
          ssh-keygen -lf /tmp/deploy_key || true
          # generate public key from private to compare on server if needed
          ssh-keygen -y -f /tmp/deploy_key > /tmp/deploy_key.pub || true
          echo "Key fingerprint (public key):"
          ssh-keygen -lf /tmp/deploy_key.pub || true

          echo "Attempting verbose SSH connection (will exit immediately if succeeds)"
          ssh -i /tmp/deploy_key -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -o ConnectTimeout=15 -vvv ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} exit || true

          echo "Attempting rsync with verbose SSH (dry run)"
          RSYNC_RSH="ssh -i /tmp/deploy_key -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -vvv" \
            rsync -avz --delete --dry-run -e "$RSYNC_RSH" ${{ env.BUILD_DIR }}/ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }} || true

          echo "--- SSH debug end ---"

      - name: Deploy dist folder to server via rsync
        run: |
          rsync -avz --delete \
            --exclude=".git" \
            --exclude=".github" \
            -e "ssh -o StrictHostKeyChecking=yes" \
            ${{ env.BUILD_DIR }}/ \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}
